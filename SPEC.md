# 株価予測CLIアプリケーション仕様書

## 概要
- 株価CSVファイルを入力として読み込み、特徴量を生成したうえで線形回帰モデルにより将来の終値を予測するCUIアプリケーション。
- アプリ内で取引執行は行わず、予測精度評価(MAE/RMSE)を提示することに専念する。
- 予測や評価処理はすべて純Python実装で完結する。

## CLI
- エントリーポイント: `stock-predictor`。
- コマンド構成:
  - `forecast [<csv_path>]`: 指定CSVからデータを読み込み、学習・評価を実行する。`<csv_path>` を省略した場合は `--ticker` で指定した銘柄を yfinance から取得する。
    - `--ticker TEXT`: yfinance から取得するティッカー。指定した場合は CSV パスを同時に渡せない。
    - `--period TEXT` (既定: `60d`): yfinance ダウンロード期間。`--ticker` 利用時のみ有効。
    - `--interval TEXT` (既定: `1d`): yfinance ダウンロード間隔。`--ticker` 利用時のみ有効。
    - `--horizon INT` (既定: 1): 予測する営業日数(終値)のホライゾン。
    - `--lags INT ...`: 特徴量に含める終値ラグ。未指定時は `(1, 2, 3, 5, 10)` を利用。
    - `--cv-splits INT` (既定: 5): 時系列クロスバリデーションの分割数。
    - `--ridge FLOAT` (既定: 1e-6): リッジ回帰に適用する正則化係数。
  - 実行結果は以下を標準出力に表示する。
    - データソース（CSVパスまたはティッカー/取得条件）、予測ホライゾン、実際に利用したラグ一覧。
    - 学習データに対するMAE/RMSEと、CVの平均RMSE。
  - `backtest [<csv_path>]`: 予測モデルを利用し、閾値判定に基づく売買シグナルを生成する。`<csv_path>` を省略した場合は `forecast` と同様に `--ticker` 系オプションでデータを取得できる。
    - `--threshold FLOAT` (既定: `0`): 予測リターンが閾値を上回れば `buy`、下回れば `sell`、範囲内であれば `hold` と判定する境界値。
    - `--lags INT ...`: 学習に利用する終値ラグ。未指定時は `(1, 2, 3, 5, 10)` を利用。
    - 学習済みモデルを用いて各営業日の予測リターン、実現リターン、シグナル(`buy`/`sell`/`hold`)を一覧表示する。
    - シグナルごとのトレード回数、勝率、累積リターンなどのバックテスト指標を標準出力へ提示する。

## データ要件
- CSVはUTF-8、ヘッダー行必須。列構成は以下に完全一致する必要がある。
  - `Date, Open, High, Low, Close, Volume`
- `Date`は`YYYY-MM-DD`形式。読み込み時に日付順へソートする。
- yfinance から取得した場合は `Date, Open, High, Low, Close, Volume` を満たす行のみ採用し、欠損値や休日データは除外する。

## 特徴量エンジニアリング
- 指定ラグごとに終値のラグ値と、そのリターン(%)を生成。
- 1営業日のリターン(`daily_return`)と、終値に対する高値-安値比率(`price_range`)。
- ローリング窓幅 `(3, 5, 10, 20)` (指定可能) に対して以下を生成。
  - 単純移動平均(SMA)
  - 指数移動平均(EMA)
  - `daily_return`のローリング標準偏差(ボラティリティ)
- 出来高に対して5日窓のZスコアを算出。
- 欠損値やNaNを含む行は除外し、将来データが不足するサンプルも学習対象から除外する。

## モデリングと評価
- Ridge正則化付き線形回帰を純Pythonで実装し、バイアス項を含む。CLIから正則化係数を指定可能。正則化はバイアス項を除いて適用する。
- 時系列分割を行い、各分割で学習/評価してMAE・RMSEを算出。
- すべてのデータで再学習した最終モデルの係数と指標を返し、CVの平均RMSEを併せて報告する。
- 学習に利用可能なサンプルが存在しない場合や、パラメータが不正な場合は例外を送出する。

## テスト
- `pytest`によるユニットテストを実行し、CLI動作、データ整形、モデル評価の整合性を検証する。
